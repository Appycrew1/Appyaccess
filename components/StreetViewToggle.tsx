"use client";
import { useEffect, useMemo, useRef, useState } from "react";import { useGoogleMaps } from "./GoogleLoader";import type { PlaceLite } from "@/types";
export default function StreetViewToggle({origin,destination}:{origin:PlaceLite|null;destination:PlaceLite|null}){const ready=useGoogleMaps();const [mode,setMode]=useState<"origin"|"destination">("destination");const svRef=useRef<HTMLDivElement|null>(null);const panoRef=useRef<google.maps.StreetViewPanorama|null>(null);const svsRef=useRef<google.maps.StreetViewService|null>(null);const place=useMemo(()=>mode==="origin"?origin:destination,[mode,origin,destination]);useEffect(()=>{if(ready&&!svsRef.current)svsRef.current=new google.maps.StreetViewService();},[ready]);useEffect(()=>{if(!ready||!svsRef.current||!svRef.current)return;if(!place){if(panoRef.current)panoRef.current.setVisible(false);return;}const loc={lat:place.lat,lng:place.lng};svsRef.current.getPanorama({location:loc,radius:70},(data,status)=>{if(status===google.maps.StreetViewStatus.OK&&data?.location?.latLng){if(!panoRef.current){panoRef.current=new google.maps.StreetViewPanorama(svRef.current!,{position:data.location.latLng,pov:{heading:0,pitch:0},visible:true});}else{panoRef.current.setPosition(data.location.latLng);panoRef.current.setVisible(true);}}else{if(panoRef.current)panoRef.current.setVisible(false);if(svRef.current)svRef.current.innerHTML='<div class="p-3 text-sm" style="opacity:.7">No Street View available.</div>';}});},[place?.place_id,ready]);const staticImgUrl=useMemo(()=>{if(!place||!process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY)return"";const {lat,lng}=place;const key=process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;return `https://maps.googleapis.com/maps/api/streetview?size=600x300&location=${lat},${lng}&key=${key}`;},[place?.place_id]);return(<div className="space-y-3"><div className="flex" style={{gap:8}}><button className={`btn ${mode==='origin'?'btn-primary':'btn-ghost'}`} onClick={()=>setMode('origin')}>Origin</button><button className={`btn ${mode==='destination'?'btn-primary':'btn-ghost'}`} onClick={()=>setMode('destination')}>Destination</button></div><div className="grid md:grid-cols-2" style={{gap:16}}><div className="card" style={{height:'18rem',overflow:'hidden'}}><div className="p-2 text-xs" style={{opacity:.7}}>Street View (interactive)</div><div ref={svRef} style={{height:'calc(100% - 28px)'}} /></div><div className="card" style={{height:'18rem',overflow:'hidden'}}><div className="p-2 text-xs" style={{opacity:.7}}>Street View Image</div><div className="h-[calc(100%-28px)] w-full grid place-items-center">{staticImgUrl?<img src={staticImgUrl} alt="Street View" style={{width:'100%',height:'100%',objectFit:'cover'}}/>:<div className="p-3 text-sm" style={{opacity:.7}}>No image.</div>}</div></div></div></div>);}
