import * as cheerio from "cheerio";import { aiExtract } from "@/lib/aiExtract";
export async function scrapePlanning(postcode:string){const list=(process.env.PLANNING_PORTAL_URLS||"").split(",").map(s=>s.trim()).filter(Boolean);const notes:string[]=[];for(const base of list){try{const url=`${base}?q=${encodeURIComponent(postcode)}`;const r=await fetch(url,{cache:"no-store"});if(!r.ok)continue;const html=await r.text();const $=cheerio.load(html);const text=$("body").text().replace(/\s+/g," ").trim();const ai=await aiExtract<{notes:string[]}>("Extract access-related notes from planning search results (stairs, lifts, parking, loading bay, access width). Return JSON.",text.slice(0,25000),'{ "notes": ["string"] }');if(ai?.notes?.length)notes.push(...ai.notes.map(s=>`${s} (source: ${base})`));}catch{}}return notes;}
