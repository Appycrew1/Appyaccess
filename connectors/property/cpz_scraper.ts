import * as cheerio from "cheerio";import { aiExtract } from "@/lib/aiExtract";import type { CPZRule } from "@/types";
export async function scrapeCPZ():Promise<CPZRule[]>{const list=(process.env.CPZ_PAGES||"").split(",").map(s=>s.trim()).filter(Boolean);const out:CPZRule[]=[];for(const page of list){try{const r=await fetch(page,{cache:"no-store"});if(!r.ok)continue;const html=await r.text();const $=cheerio.load(html);const rows=$("table tr").map((_,tr)=>$(tr).find("td,th").map((_,td)=>$(td).text().trim()).get()).get();if(rows.length>1){for(const row of rows){if(Array.isArray(row)&&row.join("").length>0){out.push({zone:row[0],hours:row.slice(1).join(" | "),source:page});}}continue;}const ai=await aiExtract<CPZRule[]>("Extract CPZ (Controlled Parking Zone) rules from HTML text: zone name, hours, and a short note.",html.slice(0,25000),'[ { "zone":"string", "hours":"string", "notes?":"string" } ]');if(ai)ai.forEach(a=>out.push({...a,source:page}));}catch{}}return out;}
